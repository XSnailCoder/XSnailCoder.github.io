---
layout:     post
title:      "ios æ¶ˆæ¯è½¬å‘æœºåˆ¶"
subtitle:   "ä¸é€‚åˆäººç±»é˜…è¯»ï¼Œéå¸¸æ°´çš„è‡ªæˆ‘ç¬”è®°"
date:       2016-6-14
author:     "xsnailcoder"
header-img: "img/post-bg-unix-linux.jpg"
tags:
    - iOS

    
---


## iOS æ¶ˆæ¯è½¬å‘


æœ¬æ–‡å°±ä¸»è¦æ¥ä»‹ç»ä¸€ä¸‹iOSç³»ç»Ÿçš„æ¶ˆæ¯è½¬å‘æœºåˆ¶ï¼Œæ¢ç©¶ä¸€ä¸‹åœ¨è°ƒç”¨ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œå¦‚æœæœ¬ç±»ä¸­æ²¡æœ‰è¯¥æ–¹æ³•æ—¶ï¼Œå¯¹è±¡ç©¶ç«Ÿæ˜¯å¦‚ä½•è¿›è¡Œæ¶ˆæ¯è½¬å‘çš„ï¼Œæ¥é¿å…ç¨‹åºæŠ›å‡ºå¼‚å¸¸ã€‚
### å¼‚å¸¸ç°è±¡
é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæ˜¯ä»¥[object message]çš„æ–¹å¼è°ƒç”¨æ–¹æ³•ï¼Œå¦‚æœobjectæ— æ³•å“åº”messageæ¶ˆæ¯æ—¶ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™ã€‚ä½†å¦‚æœæ˜¯ä»¥performâ€¦çš„å½¢å¼æ¥è°ƒç”¨ï¼Œåˆ™éœ€è¦ç­‰åˆ°è¿è¡Œæ—¶æ‰èƒ½ç¡®å®šobjectæ˜¯å¦èƒ½æ¥æ”¶messageæ¶ˆæ¯ã€‚å¦‚æœä¸èƒ½ï¼Œåˆ™ç¨‹åºå´©æºƒã€‚ 


> Terminating app due to uncaught exception 'NSInvalidArgumentException', reason: '-[Person eat]: unrecognized selector sent to instance 0x60800000a930'


### è§£å†³æ–¹æ³•

é€šå¸¸ï¼Œå½“æˆ‘ä»¬ä¸èƒ½ç¡®å®šä¸€ä¸ªå¯¹è±¡æ˜¯å¦èƒ½æ¥æ”¶æŸä¸ªæ¶ˆæ¯æ—¶ï¼Œä¼šå…ˆè°ƒç”¨respondsToSelector:æ¥åˆ¤æ–­ä¸€ä¸‹ã€‚å¦‚ä¸‹ä»£ç æ‰€ç¤º


	if([self respondsToSelector:@selector(method)]){
	      [self performSelector:@selector(method)];
	}
	
æˆ‘ä»¬è¿™è¾¹æƒ³è®¨è®ºä¸‹ä¸ä½¿ç”¨respondsToSelector:åˆ¤æ–­çš„æƒ…å†µ,å½“ä¸€ä¸ªå¯¹è±¡æ— æ³•æ¥æ”¶æŸä¸€æ¶ˆæ¯æ—¶ï¼Œå°±ä¼šå¯åŠ¨æ‰€è°“â€œæ¶ˆæ¯è½¬å‘(message forwarding)â€æœºåˆ¶ï¼Œé€šè¿‡è¿™ä¸€æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥å‘Šè¯‰å¯¹è±¡å¦‚ä½•å¤„ç†æœªçŸ¥çš„æ¶ˆæ¯ã€‚

### æ¶ˆæ¯è½¬å‘æœºåˆ¶åŸºæœ¬ä¸Šåˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤

**1.åŠ¨æ€æ–¹æ³•è§£æ**

**2.å¤‡ç”¨æ¥æ”¶è€…**

**3.å®Œæ•´è½¬å‘**

#### æ¶ˆæ¯è½¬å‘çš„æµç¨‹å›¾
![ios](/img/ios/runtime/sendMessage.png)

#### 1.åŠ¨æ€æ–¹æ³•è§£æ
å¯¹è±¡åœ¨æ”¶åˆ°æ— æ³•å¤„ç†çš„æ¶ˆæ¯æ—¶ï¼Œä¼šè°ƒç”¨ä¸‹é¢çš„æ–¹æ³•ï¼Œå‰è€…æ˜¯è°ƒç”¨ç±»æ–¹æ³•æ—¶ä¼šè°ƒç”¨ï¼Œåè€…æ˜¯è°ƒç”¨å¯¹è±¡æ–¹æ³•æ—¶ä¼šè°ƒç”¨

	//ç±»æ–¹æ³•ä¸“ç”¨
	//+ (BOOL)resolveClassMethod:(SEL)sel
	//å¯¹è±¡æ–¹æ³•ä¸“ç”¨
	//+ (BOOL)resolveInstanceMethod:(SEL)sel

åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œéœ€è¦ç»™å¯¹è±¡æ‰€å±ç±»åŠ¨æ€çš„æ·»åŠ ä¸€ä¸ªæ–¹æ³•ï¼Œå¹¶è¿”å›YESï¼Œè¡¨æ˜å¯ä»¥å¤„ç†

	+ (BOOL)resolveInstanceMethod:(SEL)sel
	{
	    if ([NSStringFromSelector(sel) isEqualToString:@"eat"]) {
	        /**
	         @param self ç»™å“ªä¸ªç±»æ·»åŠ æ–¹æ³•
	         @param sel  æ·»åŠ æ–¹æ³•çš„æ–¹æ³•ç¼–å·
	         @param IMP  æ·»åŠ æ–¹æ³•çš„å‡½æ•°å®ç°ï¼ˆå‡½æ•°åœ°å€ï¼‰æ˜¯Cè¯­è¨€çš„å®ç°çš„
	         @param æ–°æ·»åŠ çš„æ–¹æ³•çš„ç±»å‹ï¼ŒåŒ…å«å‡½æ•°çš„è¿”å›å€¼ä»¥åŠå‚æ•°å†…å®¹ç±»å‹
	         **/
	        class_addMethod(self, sel, (IMP)eat, "v@:");
	        return YES;
	    }
	    return NO;
	}
	
	//å‡½æ•°å®ç°
	void eat(id self,SEL sel)
	{
	    printf("äººåœ¨åƒğŸš\n");
	}

#### 2.å¤‡ç”¨æ¥æ”¶è€…
ç»å†äº†ç¬¬ä¸€æ­¥åï¼Œå¦‚æœè¯¥æ¶ˆæ¯è¿˜æ˜¯æ— æ³•å¤„ç†ï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨ä¸‹é¢çš„æ–¹æ³•ï¼ŒæŸ¥è¯¢æ˜¯å¦æœ‰å…¶å®ƒå¯¹è±¡èƒ½å¤Ÿå¤„ç†è¯¥æ¶ˆæ¯ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•é‡Œï¼Œæˆ‘ä»¬éœ€è¦è¿”å›ä¸€ä¸ªèƒ½å¤Ÿå¤„ç†è¯¥æ¶ˆæ¯çš„å¯¹è±¡

	- (id)forwardingTargetForSelector:(SEL)aSelector
	{
	    if ([@"eat" isEqualToString:NSStringFromSelector(aSelector)])
	    {
	        return [[Student alloc]init];
	    }
	    return [super forwardingTargetForSelector:aSelector];
	}
	
Studentç±»

	@implementation Student
	- (void)run {
	    NSLog(@"å­¦ç”Ÿåœ¨è·‘");
	}
	- (void)eat {
        NSLog(@"å­¦ç”Ÿåœ¨åƒç±³");
    }

#### 3.å®Œæ•´è½¬å‘

å¦‚æœåœ¨ä¸Šä¸€æ­¥è¿˜ä¸èƒ½å¤„ç†æœªçŸ¥æ¶ˆæ¯ï¼Œåˆ™å”¯ä¸€èƒ½åšçš„å°±æ˜¯å¯ç”¨å®Œæ•´çš„æ¶ˆæ¯è½¬å‘æœºåˆ¶äº†ã€‚ æˆ‘ä»¬é¦–å…ˆè¦é€šè¿‡,æŒ‡å®šæ–¹æ³•ç­¾åï¼Œè‹¥è¿”å›nilï¼Œåˆ™è¡¨ç¤ºä¸å¤„ç†ã€‚ å¦‚ä¸‹ä»£ç 


	- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector
	{
	    ///ä¸ºæŒ‡å®šçš„æ–¹æ³•æ‰‹åŠ¨ç”Ÿæˆç­¾å
	    if ([@"eat" isEqualToString:NSStringFromSelector(aSelector)]) {
	        return [NSMethodSignature signatureWithObjCTypes:"v@:"];
	    }
	    return [super methodSignatureForSelector:aSelector];
	}
	
	- (void)forwardInvocation:(NSInvocation *)anInvocation
	{
	    if ([self respondsToSelector:@selector(run)]) {
	        //è‡ªå·±å¤„ç†
	        [anInvocation setSelector:@selector(run)];
	        [anInvocation invokeWithTarget:self];
	        return;
	    } else {
	        //å°†æ¶ˆæ¯è½¬å‘ç»™Studentå¯¹è±¡
	        Student *stu = [[Student alloc]init];
	        if ([stu respondsToSelector:@selector(run)]) {
	            [anInvocation invokeWithTarget:stu];
	            [anInvocation setSelector:@selector(run)];
	            return;
	        }
	    }
	    //ä»ç»§æ‰¿æ ‘ä¸­æŸ¥æ‰¾
	    [super forwardInvocation:anInvocation];
	}
	
	- (void)run {
	    NSLog(@"äººåœ¨è·‘");
	}




